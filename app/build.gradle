/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java application project to get you started.
 * For more details on building Java & JVM projects, please refer to https://docs.gradle.org/8.8/userguide/building_java_projects.html in the Gradle documentation.
 */
plugins {
    id 'application'
    id 'checkstyle'
    id 'jacoco'
    id 'com.github.johnrengelman.shadow' version '8.1.1'
    id 'io.freefair.lombok' version '8.11'
    id 'com.adarshr.test-logger' version '4.0.0'
    id 'com.github.ben-manes.versions' version '0.51.0'

    id 'org.springframework.boot' version '3.4.0'
    id 'io.spring.dependency-management' version '1.1.6'
    id 'io.sentry.jvm.gradle' version '4.14.1'
}

group = 'hexlet.code'
version = '0.0.1-SNAPSHOT'

application {
    mainClass = 'hexlet.code.AppApplication'
}

repositories {
    gradlePluginPortal()
    mavenCentral()
}

ext {
    springVersion = '6.2.1'
    springBootVersion = '3.4.0'
    springSecurityTestVersion = '6.4.1'
    hibernateCoreVersion = '6.6.3.Final'
    mapStructVersion = '1.6.3'
    jacksonDatabindNullableVersion = '0.2.6'
    h2Version = '2.3.232'
    postgresqlVersion = '42.7.4'
    lombokVersion = '1.18.36'
    lombokMapstructBindingVersion = '0.2.0'
    datafakerVersion = '2.4.2'
    instancioVersion = '5.2.1'
    sentryVersion = '7.18.1'
    jsonUnitVersion = '4.1.0'
    junitVersion = '5.11.3'
    junitPlatformVersion = '1.11.1'
}

dependencies {
    implementation "org.springframework:spring-core:$springVersion"
    implementation "org.springframework.boot:spring-boot-starter:$springBootVersion"
    implementation "org.springframework.boot:spring-boot-starter-web:$springBootVersion"
    implementation "org.springframework.boot:spring-boot-starter-validation:$springBootVersion"
    implementation "org.springframework.boot:spring-boot-devtools:$springBootVersion"
    implementation "org.springframework.boot:spring-boot-starter-data-jpa:$springBootVersion"
    implementation "org.springframework.boot:spring-boot-starter-security:$springBootVersion"
    implementation "org.springframework.boot:spring-boot-starter-oauth2-resource-server:$springBootVersion"
    implementation "org.springframework:spring-webmvc:6.2.1"
    testImplementation "org.springframework.security:spring-security-test:$springSecurityTestVersion"
    testImplementation "org.springframework.boot:spring-boot-starter-test:$springBootVersion"

    implementation "org.hibernate:hibernate-core:$hibernateCoreVersion"

    implementation "org.mapstruct:mapstruct:$mapStructVersion"
    annotationProcessor "org.mapstruct:mapstruct-processor:$mapStructVersion"

    implementation "org.openapitools:jackson-databind-nullable:$jacksonDatabindNullableVersion"

    runtimeOnly "com.h2database:h2:$h2Version"
    runtimeOnly "org.postgresql:postgresql:$postgresqlVersion"

//    compileOnly "org.projectlombok:lombok:$lombokVersion"
//    annotationProcessor "org.projectlombok:lombok:$lombokVersion"
//    testCompileOnly "org.projectlombok:lombok:$lombokVersion"
//    testAnnotationProcessor "org.projectlombok:lombok:$lombokVersion"
//    implementation "org.projectlombok:lombok-mapstruct-binding:$lombokMapstructBindingVersion"

    implementation "net.datafaker:datafaker:$datafakerVersion"
    implementation "org.instancio:instancio-junit:$instancioVersion"

//    implementation "io.sentry:sentry-spring-boot-starter:$sentryVersion"
//    implementation "io.sentry:sentry-spring-boot-starter-jakarta:$sentryVersion"
//    implementation platform("io.sentry:sentry-bom:$sentryVersion") //import bom
//    implementation('io.sentry:sentry') //no version specified
//    implementation('io.sentry:sentry-logback') //no version specified
    implementation 'org.slf4j:slf4j-api:2.0.16'

    testImplementation("org.assertj:assertj-core:3.26.3")
    testImplementation "net.javacrumbs.json-unit:json-unit-assertj:$jsonUnitVersion"
//    testImplementation 'org.mockito:mockito-core:5.14.2'

//    testImplementation platform("org.junit:junit-bom:$junitVersion")
//    testImplementation "org.junit.platform:junit-platform-launcher"
    testImplementation "org.junit.jupiter:junit-jupiter:$junitVersion"
//    testImplementation "org.junit.jupiter:junit-jupiter-api:$junitVersion"
//    testRuntimeOnly "org.junit.jupiter:junit-jupiter-engine:$junitVersion"
//    testImplementation "org.junit.jupiter:junit-jupiter-params:$junitVersion"
//    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'

    implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.7.0'
    implementation 'org.springdoc:springdoc-openapi-starter-webmvc-api:2.7.0'
    implementation 'org.springdoc:springdoc-openapi-starter-webflux-api:2.7.0'

    //testImplementation libs.junit.jupiter
    //implementation 'com.google.guava:guava:33.0.0-jre'
//    implementation 'org.slf4j:slf4j-api:1.7.32'
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

tasks.named('test') {
    useJUnitPlatform()
}

test {
    finalizedBy jacocoTestReport // report is always generated after tests run
}

jacocoTestReport {
    dependsOn test // tests are required to run before generating the report
    reports {
        xml.required = true
    }
}

testlogger {
    theme 'mocha'
    showExceptions true
    showStackTraces true
    showFullStackTraces true
    showCauses true
    slowThreshold 2000
    showSummary true
    showSimpleNames false
    showPassed true
    showSkipped true
    showFailed true
    showOnlySlow false
    showStandardStreams false
    showPassedStandardStreams true
    showSkippedStandardStreams true
    showFailedStandardStreams true
    logLevel 'lifecycle'
}

def isNonStable = { String version ->
    def stableKeyword = ['RELEASE', 'FINAL', 'GA'].any { it -> version.toUpperCase().contains(it) }
    def regex = /^[0-9,.v-]+(-r)?$/
    return !stableKeyword && !(version ==~ regex)
}

dependencyUpdates {
    checkForGradleUpdate = true
//    outputFormatter = "json,xml,plain"
//    outputDir = "build/dependencyUpdates"
//    reportfileName = "report"
    checkConstraints = true
    rejectVersionIf {
        isNonStable(it.candidate.version)
    }
}

sentry {
//     Generates a JVM (Java, Kotlin, etc.) source bundle and uploads your source code to Sentry.
//     This enables source context, allowing you to see your source
//     code as part of your stack traces in Sentry.
    includeSourceContext = false
    org = "mycompany-k9"
    projectName = "java-project-99"
    authToken = System.getenv("SENTRY_AUTH_TOKEN")
}
